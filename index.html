<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Gift Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .setup-section {
            background: #e8f5e9;
            border: 2px solid #0f5e3a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-section h3 {
            color: #0f5e3a;
            margin-bottom: 15px;
        }

        .setup-section p {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .room-code-display {
            background: white;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .room-code-display .code {
            font-size: 32px;
            font-weight: 700;
            color: #c41e3a;
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #0f5e3a;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }

        .setup-section button {
            width: 100%;
            background: #0f5e3a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .setup-section button:hover {
            background: #0a4529;
        }

        .setup-section button.secondary {
            background: #c41e3a;
        }

        .setup-section button.secondary:hover {
            background: #a01828;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #d4af37;
            border-bottom-color: #d4af37;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0f5e3a;
        }

        .birthday-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .category-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .category-title {
            font-size: 18px;
            font-weight: 700;
            color: #c41e3a;
            margin-bottom: 15px;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .option-button {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #333;
        }

        .option-button:hover {
            border-color: #0f5e3a;
            background: #e8f5e9;
        }

        .option-button.selected {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .custom-input {
            margin-top: 10px;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-add-custom {
            margin-top: 5px;
            padding: 8px 16px;
            background: #0f5e3a;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .participant-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #d4af37;
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .participant-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .participant-birthday {
            color: #666;
            font-size: 14px;
        }

        .participant-preferences {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .preference-item {
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
        }

        .preference-label {
            font-weight: 600;
            color: #0f5e3a;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .match-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d4af37;
        }

        .match-giver {
            font-size: 20px;
            font-weight: 700;
            color: #c41e3a;
            margin-bottom: 10px;
        }

        .match-arrow {
            font-size: 24px;
            color: #0f5e3a;
            margin: 10px 0;
        }

        .match-receiver {
            font-size: 18px;
            font-weight: 600;
            color: #0f5e3a;
        }

        .match-preferences {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .match-pref-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .my-match-card {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .my-match-card h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .my-match-card .receiver-name {
            font-size: 32px;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .my-match-card .receiver-birthday {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .my-match-preferences {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .my-match-preferences h3 {
            color: #c41e3a;
            margin-bottom: 15px;
            text-align: center;
        }

        .no-match-found {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .birthday-inputs {
                grid-template-columns: 1fr;
            }
            .tab {
                font-size: 12px;
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üéÖ Secret Santa</h1>
            <p>Gift Matcher</p>
        </div>

        <div class="content">
            <div id="setupSection" class="setup-section">
                <h3>üéÑ Welcome to Secret Santa!</h3>
                <p>Create a new room or join an existing one.</p>
                
                <div id="roomActions">
                    <button onclick="createNewRoom()">Create New Room</button>
                    <p style="text-align: center; margin: 15px 0; color: #666;">- OR -</p>
                    <input type="text" id="roomCodeInput" placeholder="Enter Room Code" maxlength="6">
                    <button onclick="joinRoom()" class="secondary">Join Existing Room</button>
                </div>

                <div id="roomCreatedView" class="hidden">
                    <div class="room-code-display">
                        <p style="font-size: 14px; color: #666; margin-bottom: 5px;">Your Room Code:</p>
                        <div class="code" id="displayRoomCode"></div>
                        <p style="font-size: 13px; color: #666; margin-top: 5px;">Share this code with your team!</p>
                    </div>
                    <button onclick="startUsingRoom()">Start Using Room</button>
                </div>

                <div id="statusMessage"></div>
            </div>

            <div id="appContent" class="hidden">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <span style="color: #666; font-size: 14px;">Room Code: </span>
                    <span style="color: #c41e3a; font-weight: 700; font-size: 18px;" id="currentRoomCode"></span>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showHomeTab()">üè† Home</button>
                    <button class="tab" onclick="showAddTab()">‚ûï Add Person</button>
                    <button class="tab" onclick="showViewTab()">üë• View All (<span id="participantCount">0</span>)</button>
                    <button class="tab" onclick="showMatchTab()">üéÅ Matcher</button>
                    <button class="tab" id="findMatchTab" onclick="showFindMatchTab()" style="display: none;">üîç My Match</button>
                </div>

                <div id="homeSection">
                    <div style="text-align: center; padding: 40px 20px;">
                        <h2 style="color: #c41e3a; font-size: 32px; margin-bottom: 20px;">üéÖ Secret Santa Event</h2>
                        
                        <div id="countdownDisplay" class="hidden">
                            <div style="background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                                <p style="font-size: 18px; margin-bottom: 15px; opacity: 0.9;">Time Until Gift Exchange:</p>
                                <div id="countdownTimer" style="font-size: 48px; font-weight: 700; letter-spacing: 2px;"></div>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: left;">
                                <h3 style="color: #c41e3a; margin-bottom: 15px; text-align: center;">üìÖ Event Details</h3>
                                <div style="margin-bottom: 15px;">
                                    <div style="font-weight: 600; color: #0f5e3a; margin-bottom: 5px;">üìÜ Date & Time:</div>
                                    <div id="eventDateTime" style="font-size: 16px; color: #333;"></div>
                                </div>
                                <div id="addressDisplay" class="hidden">
                                    <div style="font-weight: 600; color: #0f5e3a; margin-bottom: 5px;">üìç Location:</div>
                                    <div id="eventAddressText" style="font-size: 16px; color: #333;"></div>
                                </div>
                            </div>
                        </div>

                        <div id="noEventMessage" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; color: #856404;">
                            <p style="font-size: 18px; margin-bottom: 10px;">‚è∞ Event Date Not Set</p>
                            <p style="font-size: 14px;">The organizer hasn't set the gift exchange date yet. Check back later!</p>
                        </div>

                        <div id="eventSetter" class="hidden" style="background: #e8f5e9; border: 2px solid #0f5e3a; border-radius: 10px; padding: 20px; margin-top: 20px;">
                            <h3 style="color: #0f5e3a; margin-bottom: 15px;">üìÖ Set Event Details (Organizer Only)</h3>
                            <div class="form-group">
                                <label>Event Date:</label>
                                <input type="date" id="eventDateInput" style="text-align: center;">
                            </div>
                            <div class="form-group">
                                <label>Event Time:</label>
                                <input type="time" id="eventTimeInput" style="text-align: center;">
                            </div>
                            <div class="form-group">
                                <label>Event Address/Location:</label>
                                <textarea id="eventAddressInput" placeholder="Enter the address or location details..." style="min-height: 80px; resize: vertical;"></textarea>
                            </div>
                            <button onclick="saveEventDate()" style="width: 100%; background: #0f5e3a; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                Save Event Details
                            </button>
                        </div>

                        <div style="margin-top: 40px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Quick Links</h3>
                            <button onclick="showAddTab()" style="background: white; border: 2px solid #0f5e3a; color: #0f5e3a; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 5px;">
                                ‚ûï Add Your Info
                            </button>
                            <button onclick="showViewTab()" style="background: white; border: 2px solid #d4af37; color: #d4af37; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 5px;">
                                üë• View Participants
                            </button>
                        </div>
                    </div>
                </div>

                <div id="addSection">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="nameInput" placeholder="Enter full name">
                    </div>

                    <div class="form-group">
                        <label>Birthday *</label>
                        <div class="birthday-inputs">
                            <select id="monthInput">
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <input type="number" id="dayInput" placeholder="Day" min="1" max="31">
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px; color: #333;">Gift Preferences</h3>

                    <div id="categoriesContainer"></div>

                    <button onclick="addParticipant()" class="btn-primary">Add Participant</button>
                </div>

                <div id="viewSection" class="hidden">
                    <div id="organizerControls" class="hidden" style="margin-bottom: 20px; text-align: center;">
                        <button onclick="deleteRoom()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üóëÔ∏è Delete Room (Organizer Only)
                        </button>
                    </div>
                    <div class="participant-list" id="participantList"></div>
                </div>

                <div id="matchSection" class="hidden">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button onclick="generateMatches()" class="btn-primary" style="max-width: 300px; margin: 0 auto;">
                            Generate Matches
                        </button>
                    </div>
                    <div id="matchesList"></div>
                </div>

                <div id="findMatchSection" class="hidden">
                    <div style="max-width: 400px; margin: 0 auto;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px; text-align: center;">üéÅ Find Your Secret Santa Match</h3>
                            <p style="color: #666; font-size: 14px; margin-bottom: 20px; text-align: center;">
                                Enter your name exactly as you entered it when you signed up:
                            </p>
                            <div class="form-group">
                                <input type="text" id="findNameInput" placeholder="Enter your name" style="text-align: center;">
                            </div>
                            <button onclick="findMyMatch()" class="btn-primary">Find My Match</button>
                        </div>
                        <div id="myMatchResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qmnxezjxjxfltmbpxbec.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbnhlemp4anhmbHRtYnB4YmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDc0NTksImV4cCI6MjA4MDUyMzQ1OX0.LGlh7vkaJTLVcI6O5UHEHhQ-QKzirnWZPY9SGKM5USI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const GIFT_CATEGORIES = {
            hobbies: {
                title: "Hobbies & Interests",
                options: ["Reading", "Gaming", "Sports", "Cooking", "Gardening", "Photography", "Music", "Crafts", "Traveling", "Fitness"]
            },
            foodDrink: {
                title: "Food & Drink",
                options: ["Coffee", "Tea", "Wine", "Chocolate", "Snacks", "Gourmet Foods", "Baking", "Cocktails", "Beer", "Candy"]
            },
            style: {
                title: "Style & Fashion",
                options: ["Jewelry", "Watches", "Scarves", "Bags", "Sunglasses", "Hats", "Ties", "Socks", "Belts", "Accessories"]
            },
            tech: {
                title: "Tech & Gadgets",
                options: ["Phone Accessories", "Smart Home", "Headphones", "Charging Cables", "USB Drives", "Bluetooth Speakers", "Webcam", "Mouse/Keyboard", "Power Bank", "Tech Organizer"]
            },
            wellness: {
                title: "Wellness & Self-Care",
                options: ["Candles", "Bath Products", "Skincare", "Aromatherapy", "Massage Tools", "Meditation Items", "Essential Oils", "Face Masks", "Lip Balm", "Hand Cream"]
            },
            home: {
                title: "Home & Office",
                options: ["Desk Organizer", "Plants", "Picture Frames", "Mugs", "Coasters", "Blankets", "Pillows", "Wall Art", "Notebooks", "Pens"]
            }
        };

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        let currentRoomCode = null;
        let currentRoomId = null;
        let participants = [];
        let selectedPreferences = {};
        let matches = [];
        let syncChannel = null;
        let isOrganizer = false; // Track if this user created the room
        let eventDate = null; // Store the event date/time
        let eventAddress = null; // Store the event address

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-message ' + type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createNewRoom() {
            showStatus('Creating room...', 'info');
            currentRoomCode = generateRoomCode();

            try {
                const { data, error } = await supabase
                    .from('secret_santa_rooms')
                    .insert([
                        { 
                            room_code: currentRoomCode,
                            participants: [],
                            matches: [],
                            event_date: null,
                            event_address: null
                        }
                    ])
                    .select()
                    .single();

                if (error) throw error;

                currentRoomId = data.id;
                isOrganizer = true; // Mark as organizer
                localStorage.setItem('isOrganizer_' + currentRoomCode, 'true');
                document.getElementById('displayRoomCode').textContent = currentRoomCode;
                document.getElementById('roomActions').classList.add('hidden');
                document.getElementById('roomCreatedView').classList.remove('hidden');
                showStatus('‚úÖ Room created successfully!', 'success');
            } catch (error) {
                console.error('Error creating room:', error);
                showStatus('‚ùå Error creating room: ' + error.message, 'error');
            }
        }

        async function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showStatus('Please enter a valid 6-character room code', 'error');
                return;
            }

            showStatus('Joining room...', 'info');
            currentRoomCode = code;

            try {
                const { data, error } = await supabase
                    .from('secret_santa_rooms')
                    .select('*')
                    .eq('room_code', currentRoomCode)
                    .single();

                if (error || !data) {
                    showStatus('‚ùå Room not found. Please check the code and try again.', 'error');
                    return;
                }

                currentRoomId = data.id;
                participants = data.participants || [];
                matches = data.matches || [];
                eventDate = data.event_date;
                eventAddress = data.event_address;
                
                // Check if this user is the organizer
                isOrganizer = localStorage.getItem('isOrganizer_' + currentRoomCode) === 'true';
                
                startUsingRoom();
            } catch (error) {
                console.error('Error joining room:', error);
                showStatus('‚ùå Error joining room: ' + error.message, 'error');
            }
        }

        function startUsingRoom() {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = currentRoomCode;
            
            localStorage.setItem('currentRoomCode', currentRoomCode);
            localStorage.setItem('currentRoomId', currentRoomId);
            
            setupRealtimeSync();
            loadRoomData();
            renderCategories();
        }

        function setupRealtimeSync() {
            // Subscribe to changes on this room
            syncChannel = supabase
                .channel('room-' + currentRoomId)
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'secret_santa_rooms',
                        filter: 'id=eq.' + currentRoomId
                    }, 
                    (payload) => {
                        console.log('Change received!', payload);
                        loadRoomData();
                    }
                )
                .subscribe();
        }

        async function loadRoomData() {
            try {
                const { data, error } = await supabase
                    .from('secret_santa_rooms')
                    .select('*')
                    .eq('id', currentRoomId)
                    .single();

                if (error) throw error;

                participants = data.participants || [];
                matches = data.matches || [];
                eventDate = data.event_date;
                eventAddress = data.event_address;
                
                updateParticipantCount();
                renderParticipants();
                renderMatches();
                updateCountdown();
            } catch (error) {
                console.error('Error loading room data:', error);
            }
        }

        async function saveRoomData() {
            try {
                const { error } = await supabase
                    .from('secret_santa_rooms')
                    .update({ 
                        participants: participants,
                        matches: matches,
                        event_date: eventDate,
                        event_address: eventAddress,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentRoomId);

                if (error) throw error;
            } catch (error) {
                console.error('Error saving room data:', error);
                alert('Error saving data. Please check your connection.');
            }
        }

        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = participants.length;
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            Object.entries(GIFT_CATEGORIES).forEach(([categoryKey, category]) => {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = category.title;
                section.appendChild(title);

                const optionGroup = document.createElement('div');
                optionGroup.className = 'option-group';

                category.options.forEach(option => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'option-button';
                    button.textContent = option;
                    button.onclick = function() {
                        toggleOption(categoryKey, option, this);
                    };
                    optionGroup.appendChild(button);
                });

                section.appendChild(optionGroup);

                const customDiv = document.createElement('div');
                customDiv.className = 'custom-input';
                customDiv.innerHTML = `
                    <input type="text" id="custom-${categoryKey}" placeholder="Other (type your own)">
                    <button type="button" class="btn-add-custom" onclick="addCustomOption('${categoryKey}')">Add Custom Option</button>
                `;
                section.appendChild(customDiv);

                const customContainer = document.createElement('div');
                customContainer.id = `custom-container-${categoryKey}`;
                customContainer.style.marginTop = '10px';
                section.appendChild(customContainer);

                container.appendChild(section);
            });
        }

        function toggleOption(category, option, button) {
            if (!selectedPreferences[category]) {
                selectedPreferences[category] = [];
            }

            const index = selectedPreferences[category].indexOf(option);
            if (index > -1) {
                selectedPreferences[category].splice(index, 1);
                button.classList.remove('selected');
            } else {
                selectedPreferences[category].push(option);
                button.classList.add('selected');
            }
        }

        function addCustomOption(category) {
            const input = document.getElementById('custom-' + category);
            const value = input.value.trim();
            
            if (value) {
                if (!selectedPreferences[category]) {
                    selectedPreferences[category] = [];
                }
                
                selectedPreferences[category].push(value);
                
                const container = document.getElementById('custom-container-' + category);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'option-button selected';
                button.textContent = value + ' (custom)';
                button.onclick = function() {
                    const idx = selectedPreferences[category].indexOf(value);
                    if (idx > -1) {
                        selectedPreferences[category].splice(idx, 1);
                        this.remove();
                    }
                };
                container.appendChild(button);
                
                input.value = '';
            }
        }

        async function addParticipant() {
            const name = document.getElementById('nameInput').value.trim();
            const month = document.getElementById('monthInput').value;
            const day = document.getElementById('dayInput').value;

            if (!name || !month || !day) {
                alert('Please fill in name and birthday');
                return;
            }

            const participant = {
                id: Date.now().toString(),
                name: name,
                birthMonth: parseInt(month),
                birthDay: parseInt(day),
                preferences: JSON.parse(JSON.stringify(selectedPreferences))
            };

            participants.push(participant);
            await saveRoomData();
            
            // Show success message
            alert('‚úÖ Profile saved! Your information has been added to the Secret Santa.');
            
            document.getElementById('nameInput').value = '';
            document.getElementById('monthInput').value = '';
            document.getElementById('dayInput').value = '';
            selectedPreferences = {};
            renderCategories();
            
            showViewTab();
        }

        function renderParticipants() {
            const list = document.getElementById('participantList');
            
            if (participants.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <p>No participants yet</p>
                        <p style="font-size: 14px; margin-top: 5px;">Add your first person to get started!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = '';
            
            participants.forEach(participant => {
                const card = document.createElement('div');
                card.className = 'participant-card';
                
                let preferencesHTML = '';
                if (participant.preferences && Object.keys(participant.preferences).length > 0) {
                    preferencesHTML = '<div class="participant-preferences">';
                    Object.entries(participant.preferences).forEach(([categoryKey, items]) => {
                        if (items && items.length > 0) {
                            const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                            preferencesHTML += `
                                <div class="preference-item">
                                    <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                                </div>
                            `;
                        }
                    });
                    preferencesHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="participant-header">
                        <div>
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-birthday">üéÇ ${MONTHS[participant.birthMonth - 1]} ${participant.birthDay}</div>
                        </div>
                        ${isOrganizer ? `<button class="btn-delete" onclick="deleteParticipant('${participant.id}')">Delete</button>` : ''}
                    </div>
                    ${preferencesHTML}
                `;
                
                list.appendChild(card);
            });
        }

        async function deleteParticipant(id) {
            if (confirm('Are you sure you want to delete this participant?')) {
                participants = participants.filter(p => p.id !== id);
                await saveRoomData();
            }
        }

        async function saveEventDate() {
            const dateInput = document.getElementById('eventDateInput').value;
            const timeInput = document.getElementById('eventTimeInput').value;
            const addressInput = document.getElementById('eventAddressInput').value;

            if (!dateInput || !timeInput) {
                alert('Please select both date and time');
                return;
            }

            eventDate = dateInput + 'T' + timeInput;
            eventAddress = addressInput.trim() || null;
            await saveRoomData();
            
            alert('‚úÖ Event details saved!');
            updateCountdown();
        }

        function updateCountdown() {
            const countdownDisplay = document.getElementById('countdownDisplay');
            const noEventMessage = document.getElementById('noEventMessage');
            const eventSetter = document.getElementById('eventSetter');
            const addressDisplay = document.getElementById('addressDisplay');
            const eventAddressText = document.getElementById('eventAddressText');

            if (isOrganizer) {
                eventSetter.classList.remove('hidden');
                
                // Pre-fill inputs if date/address is set
                if (eventDate) {
                    const [date, time] = eventDate.split('T');
                    document.getElementById('eventDateInput').value = date;
                    document.getElementById('eventTimeInput').value = time;
                }
                if (eventAddress) {
                    document.getElementById('eventAddressInput').value = eventAddress;
                }
            } else {
                eventSetter.classList.add('hidden');
            }

            if (!eventDate) {
                countdownDisplay.classList.add('hidden');
                noEventMessage.classList.remove('hidden');
                return;
            }

            countdownDisplay.classList.remove('hidden');
            noEventMessage.classList.add('hidden');

            // Show address if available
            if (eventAddress) {
                addressDisplay.classList.remove('hidden');
                eventAddressText.textContent = eventAddress;
            } else {
                addressDisplay.classList.add('hidden');
            }

            const targetDate = new Date(eventDate);
            const eventDateTimeElement = document.getElementById('eventDateTime');
            eventDateTimeElement.textContent = targetDate.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            function updateTimer() {
                const now = new Date();
                const difference = targetDate - now;

                if (difference <= 0) {
                    document.getElementById('countdownTimer').innerHTML = "üéâ It's Time! üéâ";
                    return;
                }

                const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);

                document.getElementById('countdownTimer').innerHTML = `
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <div><div style="font-size: 56px;">${days}</div><div style="font-size: 14px; opacity: 0.8;">DAYS</div></div>
                        <div><div style="font-size: 56px;">${hours}</div><div style="font-size: 14px; opacity: 0.8;">HOURS</div></div>
                        <div><div style="font-size: 56px;">${minutes}</div><div style="font-size: 14px; opacity: 0.8;">MINUTES</div></div>
                        <div><div style="font-size: 56px;">${seconds}</div><div style="font-size: 14px; opacity: 0.8;">SECONDS</div></div>
                    </div>
                `;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }
            if (!isOrganizer) {
                alert('Only the organizer can delete the room.');
                return;
            }

            const confirmDelete = confirm('‚ö†Ô∏è WARNING: This will permanently delete the entire room and all participant data. This cannot be undone!\n\nAre you sure you want to delete this room?');
            
            if (!confirmDelete) return;

            const doubleConfirm = confirm('Are you REALLY sure? Type your room code to confirm:\n\nRoom Code: ' + currentRoomCode);
            
            if (!doubleConfirm) return;

            try {
                const { error } = await supabase
                    .from('secret_santa_rooms')
                    .delete()
                    .eq('id', currentRoomId);

                if (error) throw error;

                // Clear local storage
                localStorage.removeItem('currentRoomCode');
                localStorage.removeItem('currentRoomId');
                localStorage.removeItem('isOrganizer_' + currentRoomCode);

                // Unsubscribe from channel
                if (syncChannel) {
                    syncChannel.unsubscribe();
                }

                alert('‚úÖ Room deleted successfully!');
                
                // Reload page to start fresh
                window.location.reload();
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('‚ùå Error deleting room: ' + error.message);
            }
        }

        async function generateMatches() {
            if (participants.length < 2) {
                alert('You need at least 2 participants to generate matches!');
                return;
            }

            let receivers = [...participants];
            
            for (let i = receivers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
            }

            let isValid = false;
            let attempts = 0;
            const maxAttempts = 100;

            while (!isValid && attempts < maxAttempts) {
                isValid = true;
                for (let i = 0; i < participants.length; i++) {
                    if (participants[i].id === receivers[i].id) {
                        isValid = false;
                        const swapIndex = (i + 1) % receivers.length;
                        [receivers[i], receivers[swapIndex]] = [receivers[swapIndex], receivers[i]];
                    }
                }
                attempts++;
            }

            matches = participants.map((giver, index) => ({
                giver: giver,
                receiver: receivers[index]
            }));

            await saveRoomData();
            
            document.getElementById('findMatchTab').style.display = 'block';
            
            alert('‚úÖ Matches generated! Everyone can now use the "üîç My Match" tab to see who they\'re buying for.');
        }

        function renderMatches() {
            const list = document.getElementById('matchesList');
            
            if (matches.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <p>No matches generated yet</p>
                        <p style="font-size: 14px; margin-top: 5px;">Click "Generate Matches" to create Secret Santa pairs!</p>
                    </div>
                `;
                return;
            }

            document.getElementById('findMatchTab').style.display = 'block';

            list.innerHTML = '';
            
            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'match-card';
                
                let preferencesHTML = '';
                if (match.receiver.preferences && Object.keys(match.receiver.preferences).length > 0) {
                    preferencesHTML = '<div class="match-preferences"><div class="match-pref-title">üéØ Gift Ideas for ' + match.receiver.name + ':</div>';
                    Object.entries(match.receiver.preferences).forEach(([categoryKey, items]) => {
                        if (items && items.length > 0) {
                            const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                            preferencesHTML += `
                                <div class="preference-item">
                                    <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                                </div>
                            `;
                        }
                    });
                    preferencesHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="match-giver">${match.giver.name}</div>
                    <div class="match-arrow">‚¨áÔ∏è gives a gift to ‚¨áÔ∏è</div>
                    <div class="match-receiver">${match.receiver.name}</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">
                        üéÇ Birthday: ${MONTHS[match.receiver.birthMonth - 1]} ${match.receiver.birthDay}
                    </div>
                    ${preferencesHTML}
                `;
                
                list.appendChild(card);
            });
        }

        function findMyMatch() {
            const nameInput = document.getElementById('findNameInput').value.trim();
            const resultDiv = document.getElementById('myMatchResult');
            
            if (!nameInput) {
                alert('Please enter your name');
                return;
            }

            if (matches.length === 0) {
                resultDiv.innerHTML = `
                    <div class="no-match-found">
                        <h3>‚è≥ Matches Not Generated Yet</h3>
                        <p>The organizer hasn't generated the Secret Santa matches yet. Please check back later!</p>
                    </div>
                `;
                return;
            }

            const myMatch = matches.find(m => m.giver.name.toLowerCase() === nameInput.toLowerCase());

            if (!myMatch) {
                resultDiv.innerHTML = `
                    <div class="no-match-found">
                        <h3>‚ùå Name Not Found</h3>
                        <p>We couldn't find "${nameInput}" in the participant list.</p>
                        <p style="margin-top: 10px; font-size: 13px;">Make sure you entered your name exactly as it appears in the system.</p>
                    </div>
                `;
                return;
            }

            let preferencesHTML = '';
            if (myMatch.receiver.preferences && Object.keys(myMatch.receiver.preferences).length > 0) {
                preferencesHTML = '<div class="my-match-preferences"><h3>üéÅ Gift Ideas</h3>';
                Object.entries(myMatch.receiver.preferences).forEach(([categoryKey, items]) => {
                    if (items && items.length > 0) {
                        const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                        preferencesHTML += `
                            <div class="preference-item">
                                <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                            </div>
                        `;
                    }
                });
                preferencesHTML += '</div>';
            }

            resultDiv.innerHTML = `
                <div class="my-match-card">
                    <h2>üéÖ Your Secret Santa Match:</h2>
                    <div class="receiver-name">${myMatch.receiver.name}</div>
                    <div class="receiver-birthday">üéÇ Birthday: ${MONTHS[myMatch.receiver.birthMonth - 1]} ${myMatch.receiver.birthDay}</div>
                    ${preferencesHTML}
                </div>
            `;
        }

        function showHomeTab() {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.querySelectorAll('.tab')[4].classList.remove('active');
            document.getElementById('homeSection').classList.remove('hidden');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
            updateCountdown();
        }

        function showAddTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.querySelectorAll('.tab')[4].classList.remove('active');
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('addSection').classList.remove('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
        }

        function showViewTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.add('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.querySelectorAll('.tab')[4].classList.remove('active');
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.remove('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
            
            // Show organizer controls if organizer
            if (isOrganizer) {
                document.getElementById('organizerControls').classList.remove('hidden');
            }
        }

        function showMatchTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.add('active');
            document.querySelectorAll('.tab')[4].classList.remove('active');
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.remove('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
        }

        function showFindMatchTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.querySelectorAll('.tab')[4].classList.add('active');
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.remove('hidden');
        }

        window.onload = async function() {
            const savedRoomCode = localStorage.getItem('currentRoomCode');
            const savedRoomId = localStorage.getItem('currentRoomId');
            
            if (savedRoomCode && savedRoomId) {
                currentRoomCode = savedRoomCode;
                currentRoomId = savedRoomId;
                
                // Verify room still exists
                try {
                    const { data, error } = await supabase
                        .from('secret_santa_rooms')
                        .select('*')
                        .eq('id', currentRoomId)
                        .single();
                    
                    if (data) {
                        participants = data.participants || [];
                        matches = data.matches || [];
                        eventDate = data.event_date;
                        eventAddress = data.event_address;
                        isOrganizer = localStorage.getItem('isOrganizer_' + savedRoomCode) === 'true';
                        startUsingRoom();
                    }
                } catch (error) {
                    console.log('Could not reload previous room');
                }
            }
        };

        window.onbeforeunload = function() {
            if (syncChannel) {
                syncChannel.unsubscribe();
            }
        };
    </script>
</body>
</html>
