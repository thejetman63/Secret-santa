<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Gift Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 20px; }

        .setup-section {
            background: #e8f5e9;
            border: 2px solid #0f5e3a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-section h3 { color: #0f5e3a; margin-bottom: 15px; }

        .room-code-display {
            background: white;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        .room-code-display .code {
            font-size: 32px;
            font-weight: 700;
            color: #c41e3a;
            letter-spacing: 3px;
        }

        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #0f5e3a;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }
        .setup-section button {
            width: 100%;
            background: #0f5e3a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .setup-section button:hover { background: #0a4529; }
        .setup-section button.secondary { background: #c41e3a; }
        .setup-section button.secondary:hover { background: #a01828; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }
        .tab.active {
            color: #d4af37;
            border-bottom-color: #d4af37;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0f5e3a; }

        .birthday-inputs { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }

        .category-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .category-title { font-size: 18px; font-weight: 700; color: #c41e3a; margin-bottom: 15px; }
        .option-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .option-button {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .option-button:hover { border-color: #0f5e3a; background: #e8f5e9; }
        .option-button.selected { background: #c41e3a; color: white; border-color: #c41e3a; }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .participant-list { display: flex; flex-direction: column; gap: 10px; }
        .participant-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #d4af37;
        }
        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .status-message { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .status-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .hidden { display: none; }

        @media (max-width: 600px) {
            .birthday-inputs { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Secret Santa</h1>
            <p>Gift Matcher</p>
        </div>

        <div class="content">
            <div id="setupSection" class="setup-section">
                <h3>Welcome to Secret Santa!</h3>
                <p>Create a new room or join an existing one.</p>

                <div id="roomActions">
                    <button onclick="testConnection()" style="background:#6c757d;margin-bottom:10px;">Test Database Connection</button>
                    <button onclick="createNewRoom()">Create New Room</button>
                    <p style="text-align:center;margin:15px 0;color:#666;">— OR —</p>
                    <input type="text" id="roomCodeInput" placeholder="Enter Room Code" maxlength="6">
                    <button onclick="joinRoom()" class="secondary">Join Existing Room</button>
                </div>

                <div id="roomCreatedView" class="hidden">
                    <div class="room-code-display">
                        <p>Your Room Code:</p>
                        <div class="code" id="displayRoomCode"></div>
                        <p>Share this code with your team!</p>
                    </div>
                    <button onclick="startUsingRoom()">Start Using Room</button>
                </div>

                <div id="statusMessage"></div>
            </div>

            <div id="appContent" class="hidden">
                <div style="background:#f8f9fa;padding:10px;border-radius:10px;margin-bottom:20px;text-align:center;">
                    Room Code: <span style="color:#c41e3a;font-weight:700;font-size:18px;" id="currentRoomCode"></span>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showHomeTab()">Home</button>
                    <button class="tab" onclick="showAddTab()">Add Person</button>
                    <button class="tab" onclick="showViewTab()">View All (<span id="participantCount">0</span>)</button>
                    <button class="tab" onclick="showMatchTab()">Matcher</button>
                    <button class="tab" id="findMatchTab" onclick="showFindMatchTab()" style="display:none;">My Match</button>
                </div>

                <!-- All your sections (home, add, view, match, findMatch) stay exactly the same as in your original code -->
                <!-- (omitted here for brevity – they are unchanged) -->
                <!-- You can keep everything from <div id="homeSection"> to </div> of findMatchSection exactly as you had it -->

                <div id="homeSection">…</div>
                <div id="addSection" class="hidden">…</div>
                <div id="viewSection" class="hidden">…</div>
                <div id="matchSection" class="hidden">…</div>
                <div id="findMatchSection" class="hidden">…</div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script loading...');

        const SUPABASE_URL = 'https://qmnxezjxjxfltmbpxbec.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbnhlemp4anhmbHRtYnB4YmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDc0NTksImV4cCI6MjA4MDUyMzQ1OX0.LGlh7vkaJTLVcI6O5UHEHhQ-QKzirnWZPY9SGKM5USI';

        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase client created');
        } catch (e) {
            alert('Failed to initialize Supabase: ' + e.message);
        }

        const GIFT_CATEGORIES = { /* ... same as yours ... */ };
        const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

        let currentRoomCode = null;
        let currentRoomId = null;
        let participants = [];
        let selectedPreferences = {};
        let matches = [];
        let syncChannel = null;
        let isOrganizer = false;
        let eventDate = null;
        let eventAddress = null;

        function showStatus(msg, type='info') {
            const el = document.getElementById('statusMessage');
            el.className = 'status-message ' + type;
            el.innerHTML = msg;
            el.style.display = 'block';
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        async function testConnection() {
            showStatus('Testing connection...', 'info');
            try {
                const { error } = await supabase.from('secret_santa_rooms').select('*').limit(1);
                if (error) throw error;
                showStatus('Database connection successful!', 'success');
            } catch (e) {
                showStatus('Connection failed: ' + e.message, 'error');
            }
        }

        async function createNewRoom() {
            showStatus('Creating room...', 'info');
            currentRoomCode = generateRoomCode();

            const { data, error } = await supabase
                .from('secret_santa_rooms')
                .insert({ room_code: currentRoomCode, participants: [], matches: [], event_date: null, event_address: null })
                .select()
                .single();

            if (error) { showStatus('Error: ' + error.message, 'error'); return; }

            currentRoomId = data[0].id;
            isOrganizer = true;
            localStorage.setItem('isOrganizer_' + currentRoomCode, 'true');
            document.getElementById('displayRoomCode').textContent = currentRoomCode;
            document.getElementById('roomActions').classList.add('hidden');
            document.getElementById('roomCreatedView').classList.remove('hidden');
            showStatus('Room created!', 'success');
        }

        async function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!code || code.length !== 6) return showStatus('Invalid code', 'error');

            showStatus('Joining...', 'info');
            currentRoomCode = code;

            const { data, error } = await supabase
                .from('secret_santa_rooms')
                .select('*')
                .eq('room_code', code)
                .single();

            if (error || !data) return showStatus('Room not found', 'error');

            currentRoomId = data.id;
            participants = data.participants || [];
            matches = data.matches || [];
            eventDate = data.event_date;
            eventAddress = data.event_address;
            isOrganizer = localStorage.getItem('isOrganizer_' + code) === 'true';

            startUsingRoom();
        }

        function startUsingRoom() {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = currentRoomCode;

            localStorage.setItem('currentRoomCode', currentRoomCode);
            localStorage.setItem('currentRoomId', currentRoomId);

            setupRealtimeSync();
            loadRoomData();
            renderCategories();
        }

        // … (all other functions exactly as you wrote them: setupRealtimeSync, loadRoomData, saveRoomData,
        // renderCategories, toggleOption, addCustomOption, addParticipant, renderParticipants, deleteParticipant,
        // saveEventDate, updateCountdown, generateMatches, renderMatches, findMyMatch, tab functions, etc.)

        // THE FIXED deleteRoom function (this was the bug!)
        async function deleteRoom() {
            if (!isOrganizer) {
                alert('Only the organizer can delete the room.');
                return;
            }
            if (!confirm('WARNING: This will delete the entire room permanently. Continue?')) return;
            if (!confirm('REALLY sure? Room code: ' + currentRoomCode)) return;

            try {
                const { error } = await supabase.from('secret_santa_rooms').delete().eq('id', currentRoomId);
                if (error) throw error;

                localStorage.clear();
                if (syncChannel) syncChannel.unsubscribe();
                alert('Room deleted');
                location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // onload – try to rejoin last room
        window.onload = async () => {
            const code = localStorage.getItem('currentRoomCode');
            const id = localStorage.getItem('currentRoomId');
            if (code && id) {
                currentRoomCode = code;
                currentRoomId = id;
                try {
                    const { data } = await supabase.from('secret_santa_rooms').select('*').eq('id', id).single();
                    if (data) {
                        participants = data.participants || [];
                        matches = data.matches || [];
                        eventDate = data.event_date;
                        eventAddress = data.event_address;
                        isOrganizer = localStorage.getItem('isOrganizer_' + code) === 'true';
                        startUsingRoom();
                    }
                } catch (e) { console.log('Could not rejoin room'); }
            }
        };
    </script>
</body>
</html>
