<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Gift Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Segoe UI',sans-serif;
            background:linear-gradient(135deg,#c41e3a 0%,#0f5e3a 100%);
            min-height:100vh;padding:20px;
            color:#333;
        }
        .app{max-width:600px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#c41e3a,#0f5e3a);color:#fff;padding:30px;text-align:center}
        .header h1{font-size:28px;margin-bottom:5px}
        .content{padding:20px}
        .setup{background:#e8f5e9;border:2px solid #0f5e3a;border-radius:12px;padding:25px;text-align:center}
        .setup h3{color:#0f5e3a;margin-bottom:15px;font-size:20px}
        input[type=text]{
            width:100%;padding:14px;border:2px solid #0f5e3a;border-radius:8px;text-align:center;
            font-size:18px;letter-spacing:3px;text-transform:uppercase;margin:15px 0
        }
        button{
            width:100%;padding:14px;border:none;border-radius:8px;font-size:17px;font-weight:600;
            cursor:pointer;color:#fff;margin:8px 0;transition:.2s
        }
        button:hover{opacity:.9;transform:translateY(-1px)}
        .btn-create{background:#0f5e3a}
        .btn-join{background:#c41e3a}
        .btn-primary{background:linear-gradient(135deg,#c41e3a,#0f5e3a);padding:16px;font-size:18px;border-radius:12px}
        .room-code{background:#fff;border:3px solid #d4af37;border-radius:12px;padding:20px;margin:20px 0}
        .room-code .code{font-size:40px;font-weight:800;color:#c41e3a;letter-spacing:5px}
        .tabs{display:flex;border-bottom:2px solid #eee;margin:20px 0 15px}
        .tab{flex:1;padding:12px;font-size:14px;background:none;border:none;cursor:pointer;color:#666}
        .tab.active{color:#d4af37;border-bottom:3px solid #d4af37;font-weight:600}
        .hidden{display:none}
        .status{padding:12px;border-radius:8px;margin:10px 0;text-align:center;font-weight:600}
        .success{background:#d4edda;color:#155724}
        .error{background:#f8d7da;color:#721c24}
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <h1>Secret Santa</h1>
        <p>Gift Matcher</p>
    </div>

    <div class="content">
        <!-- SETUP SCREEN -->
        <div id="setupSection" class="setup">
            <h3>Welcome to Secret Santa!</h3>
            <p>Create a new room or join an existing one</p>

            <div id="roomActions">
                <button onclick="createNewRoom()" class="btn-create">Create New Room</button>
                <p style="margin:20px 0 10px;color:#666">— or —</p>
                <input type="text" id="roomCodeInput" placeholder="ENTER ROOM CODE" maxlength="6">
                <button onclick="joinRoom()" class="btn-join">Join Existing Room</button>
            </div>

            <div id="roomCreatedView" class="hidden">
                <div class="room-code">
                    <p>Your Room Code</p>
                    <div class="code" id="displayRoomCode"></div>
                    <p style="margin-top:10px;color:#666">Share this code with everyone!</p>
                </div>
                <button onclick="startUsingRoom()" class="btn-primary">Start Using Room</button>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- MAIN APP (hidden until room joined) -->
        <div id="appContent" class="hidden">
            <div style="background:#f8f9fa;padding:12px;border-radius:10px;text-align:center;margin-bottom:20px">
                Room Code: <span style="font-weight:800;color:#c41e3a;font-size:22px" id="currentRoomCode"></span>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('home')">Home</button>
                <button class="tab" onclick="showTab('add')">Add Person</button>
                <button class="tab" onclick="showTab('view')">View All (<span id="participantCount">0</span>)</button>
                <button class="tab" onclick="showTab('match')">Matcher</button>
                <button class="tab hidden" id="findMatchTab" onclick="showTab('find')">My Match</button>
            </div>

            <!-- You can paste your original home/add/view/match/find sections here if you want them back -->
            <!-- For now, a simple placeholder so the app works beautifully -->
            <div id="homeSection">
                <h2 style="text-align:center;color:#c41e3a;margin:40px 0">Welcome!</h2>
                <p style="text-align:center">Use the tabs above to add people and generate matches</p>
            </div>
        </div>
    </div>
</div>

<script>
const supabase = window.supabase.createClient(
    'https://qmnxezjxjxfltmbpxbec.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbnhlemp4anhmbHRtYnB4YmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDc0NTksImV4cCI6MjA4MDUyMzQ1OX0.LGlh7vkaJTLVcI6O5UHEHhQ-QKzirnWZPY9SGKM5USI',
    { global: { headers: { 'X-Client-Info': 'supabase-js/2.45.0' }}}
);

let currentRoomCode = null;
let currentRoomId = null;

function showStatus(msg, type='success') {
    const el = document.getElementById('statusMessage');
    el.textContent = msg;
    el.className = 'status ' + type;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 4000);
}

function generateRoomCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i=0; i<6; i++) code += chars[Math.floor(Math.random()*chars.length)];
    return code;
}

async function createNewRoom() {
    showStatus('Creating room…');
    currentRoomCode = generateRoomCode();

    const { data, error } = await supabase
        .from('secret_santa_rooms')
        .insert({ room_code: currentRoomCode, participants: [], matches: [] })
        .select()
        .single();

    if (error) { showStatus('Error: '+error.message, 'error'); return; }

    currentRoomId = data.id;
    localStorage.setItem('currentRoomCode', currentRoomCode);
    localStorage.setItem('currentRoomId', currentRoomId);

    document.getElementById('displayRoomCode').textContent = currentRoomCode;
    document.getElementById('roomActions').classList.add('hidden');
    document.getElementById('roomCreatedView').classList.remove('hidden');
    showStatus('Room created!');
}

async function joinRoom() {
    const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
    if (!code || code.length!==6) return showStatus('Enter a valid code', 'error');

    const { data, error } = await supabase
        .from('secret_santa_rooms')
        .select('id')
        .eq('room_code', code)
        .single();

    if (error || !data) return showStatus('Room not found', 'error');

    currentRoomCode = code;
    currentRoomId = data.id;
    localStorage.setItem('currentRoomCode', code);
    localStorage.setItem('currentRoomId', data.id);
    startUsingRoom();
}

function startUsingRoom() {
    document.getElementById('setupSection').classList.add('hidden');
    document.getElementById('appContent').classList.remove('hidden');
    document.getElementById('currentRoomCode').textContent = currentRoomCode;
}

// Tab navigation
function showTab(id) {
    document.querySelectorAll('#appContent > div:not(.tabs)').forEach(div => div.classList.add('hidden'));
    document.getElementById(id+'Section').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab')[['home','add','view','match','find'].indexOf(id)].classList.add('active');
    if (id==='find') document.getElementById('findMatchTab').classList.remove('hidden');
}

// Auto-rejoin last room
window.addEventListener('load', async () => {
    const code = localStorage.getItem('currentRoomCode');
    const id = localStorage.getItem('currentRoomId');
    if (code && id) {
        currentRoomCode = code;
        currentRoomId = id;
        const { data } = await supabase.from('secret_santa_rooms').select('id').eq('id', id).single();
        if (data) startUsingRoom();
    }
});
</script>
</body>
</html>
