<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Gift Matcher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .setup-section {
            background: #e8f5e9;
            border: 2px solid #0f5e3a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-section h3 {
            color: #0f5e3a;
            margin-bottom: 15px;
        }

        .setup-section p {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .room-code-display {
            background: white;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .room-code-display .code {
            font-size: 32px;
            font-weight: 700;
            color: #c41e3a;
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #0f5e3a;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }

        .setup-section button {
            width: 100%;
            background: #0f5e3a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .setup-section button:hover {
            background: #0a4529;
        }

        .setup-section button.secondary {
            background: #c41e3a;
        }

        .setup-section button.secondary:hover {
            background: #a01828;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #d4af37;
            border-bottom-color: #d4af37;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0f5e3a;
        }

        .birthday-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .category-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .category-title {
            font-size: 18px;
            font-weight: 700;
            color: #c41e3a;
            margin-bottom: 15px;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .option-button {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #333;
        }

        .option-button:hover {
            border-color: #0f5e3a;
            background: #e8f5e9;
        }

        .option-button.selected {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .custom-input {
            margin-top: 10px;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-add-custom {
            margin-top: 5px;
            padding: 8px 16px;
            background: #0f5e3a;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .participant-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #d4af37;
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .participant-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .participant-birthday {
            color: #666;
            font-size: 14px;
        }

        .participant-preferences {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .preference-item {
            font-size: 13px;
            color: #555;
            margin-bottom: 5px;
        }

        .preference-label {
            font-weight: 600;
            color: #0f5e3a;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .match-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d4af37;
        }

        .match-giver {
            font-size: 20px;
            font-weight: 700;
            color: #c41e3a;
            margin-bottom: 10px;
        }

        .match-arrow {
            font-size: 24px;
            color: #0f5e3a;
            margin: 10px 0;
        }

        .match-receiver {
            font-size: 18px;
            font-weight: 600;
            color: #0f5e3a;
        }

        .match-preferences {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .match-pref-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .my-match-card {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .my-match-card h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .my-match-card .receiver-name {
            font-size: 32px;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .my-match-card .receiver-birthday {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .my-match-preferences {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .my-match-preferences h3 {
            color: #c41e3a;
            margin-bottom: 15px;
            text-align: center;
        }

        .no-match-found {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .alert-box {
            background: #d1ecf1;
            border: 2px solid #0c5460;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .alert-box.error {
            background: #f8d7da;
            border-color: #721c24;
            color: #721c24;
        }

        .alert-box.success {
            background: #d4edda;
            border-color: #155724;
            color: #155724;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .birthday-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üéÖ Secret Santa</h1>
            <p>Gift Matcher</p>
        </div>

        <div class="content">
            <div class="alert-box">
                <strong>üì± Important:</strong> This version stores data in the cloud using JSONBin.io. The first person to create a room needs to get a free API key (takes 30 seconds). <a href="#" onclick="showApiInstructions(); return false;">Show me how</a>
            </div>

            <div id="apiInstructions" class="alert-box hidden" style="background: #fff3cd; border-color: #856404; color: #856404;">
                <h4 style="margin-bottom: 10px;">Get Your Free API Key:</h4>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>Go to <a href="https://jsonbin.io" target="_blank" style="color: #c41e3a; font-weight: 600;">jsonbin.io</a></li>
                    <li>Click "Sign Up Free" (no credit card needed)</li>
                    <li>Verify your email</li>
                    <li>Go to "API Keys" in the dashboard</li>
                    <li>Copy your API key</li>
                    <li>Paste it below</li>
                </ol>
                <p style="margin-top: 10px; font-size: 12px;"><strong>Note:</strong> Only the organizer needs to do this once. Everyone else just needs the room code!</p>
            </div>

            <div id="setupSection" class="setup-section">
                <h3>üéÑ Get Started</h3>
                
                <div id="apiKeySection">
                    <label>JSONBin API Key (only needed for creating rooms):</label>
                    <input type="text" id="apiKeyInput" placeholder="Paste your API key here">
                    <button onclick="saveApiKey()">Save API Key</button>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">This will be saved in your browser only.</p>
                </div>

                <div id="roomActions" class="hidden">
                    <button onclick="createNewRoom()">Create New Room</button>
                    <p style="text-align: center; margin: 15px 0; color: #666;">- OR -</p>
                    <input type="text" id="roomCodeInput" placeholder="Enter Room Code" maxlength="6">
                    <button onclick="joinRoom()" class="secondary">Join Existing Room</button>
                </div>

                <div id="roomCreatedView" class="hidden">
                    <div class="room-code-display">
                        <p style="font-size: 14px; color: #666; margin-bottom: 5px;">Your Room Code:</p>
                        <div class="code" id="displayRoomCode"></div>
                        <p style="font-size: 13px; color: #666; margin-top: 5px;">Share this code with your team!</p>
                    </div>
                    <button onclick="startUsingRoom()">Start Using Room</button>
                </div>

                <div id="statusMessage"></div>
            </div>

            <div id="appContent" class="hidden">
                <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <span style="color: #666; font-size: 14px;">Room Code: </span>
                    <span style="color: #c41e3a; font-weight: 700; font-size: 18px;" id="currentRoomCode"></span>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showAddTab()">‚ûï Add Person</button>
                    <button class="tab" onclick="showViewTab()">üë• View All (<span id="participantCount">0</span>)</button>
                    <button class="tab" onclick="showMatchTab()">üéÅ Gift Matcher</button>
                    <button class="tab" id="findMatchTab" onclick="showFindMatchTab()" style="display: none;">üîç Find My Match</button>
                </div>

                <div id="addSection">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="nameInput" placeholder="Enter full name">
                    </div>

                    <div class="form-group">
                        <label>Birthday *</label>
                        <div class="birthday-inputs">
                            <select id="monthInput">
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <input type="number" id="dayInput" placeholder="Day" min="1" max="31">
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px; color: #333;">Gift Preferences</h3>

                    <div id="categoriesContainer"></div>

                    <button onclick="addParticipant()" class="btn-primary">Add Participant</button>
                </div>

                <div id="viewSection" class="hidden">
                    <div class="participant-list" id="participantList"></div>
                </div>

                <div id="matchSection" class="hidden">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button onclick="generateMatches()" class="btn-primary" style="max-width: 300px; margin: 0 auto;">
                            Generate Matches
                        </button>
                    </div>
                    <div id="matchesList"></div>
                </div>

                <div id="findMatchSection" class="hidden">
                    <div style="max-width: 400px; margin: 0 auto;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #333; margin-bottom: 15px; text-align: center;">üéÅ Find Your Secret Santa Match</h3>
                            <p style="color: #666; font-size: 14px; margin-bottom: 20px; text-align: center;">
                                Enter your name exactly as you entered it when you signed up:
                            </p>
                            <div class="form-group">
                                <input type="text" id="findNameInput" placeholder="Enter your name" style="text-align: center;">
                            </div>
                            <button onclick="findMyMatch()" class="btn-primary">Find My Match</button>
                        </div>
                        <div id="myMatchResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GIFT_CATEGORIES = {
            hobbies: {
                title: "Hobbies & Interests",
                options: ["Reading", "Gaming", "Sports", "Cooking", "Gardening", "Photography", "Music", "Crafts", "Traveling", "Fitness"]
            },
            foodDrink: {
                title: "Food & Drink",
                options: ["Coffee", "Tea", "Wine", "Chocolate", "Snacks", "Gourmet Foods", "Baking", "Cocktails", "Beer", "Candy"]
            },
            style: {
                title: "Style & Fashion",
                options: ["Jewelry", "Watches", "Scarves", "Bags", "Sunglasses", "Hats", "Ties", "Socks", "Belts", "Accessories"]
            },
            tech: {
                title: "Tech & Gadgets",
                options: ["Phone Accessories", "Smart Home", "Headphones", "Charging Cables", "USB Drives", "Bluetooth Speakers", "Webcam", "Mouse/Keyboard", "Power Bank", "Tech Organizer"]
            },
            wellness: {
                title: "Wellness & Self-Care",
                options: ["Candles", "Bath Products", "Skincare", "Aromatherapy", "Massage Tools", "Meditation Items", "Essential Oils", "Face Masks", "Lip Balm", "Hand Cream"]
            },
            home: {
                title: "Home & Office",
                options: ["Desk Organizer", "Plants", "Picture Frames", "Mugs", "Coasters", "Blankets", "Pillows", "Wall Art", "Notebooks", "Pens"]
            }
        };

        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        let apiKey = null;
        let currentRoomCode = null;
        let currentBinId = null;
        let participants = [];
        let selectedPreferences = {};
        let matches = [];
        let syncInterval = null;

        function showApiInstructions() {
            document.getElementById('apiInstructions').classList.remove('hidden');
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'alert-box ' + type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showStatus('Please enter an API key', 'error');
                return;
            }
            
            apiKey = key;
            localStorage.setItem('jsonbinApiKey', key);
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('roomActions').classList.remove('hidden');
            showStatus('API key saved! You can now create or join a room.', 'success');
        }

        async function createNewRoom() {
            if (!apiKey) {
                showStatus('Please enter your API key first', 'error');
                return;
            }

            showStatus('Creating room...', 'info');
            currentRoomCode = generateRoomCode();

            const roomData = {
                roomCode: currentRoomCode,
                participants: [],
                matches: [],
                created: new Date().toISOString()
            };

            try {
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Name': 'SecretSanta_' + currentRoomCode
                    },
                    body: JSON.stringify(roomData)
                });

                const result = await response.json();
                
                if (result.metadata && result.metadata.id) {
                    currentBinId = result.metadata.id;
                    localStorage.setItem('roomMapping_' + currentRoomCode, currentBinId);
                    
                    document.getElementById('displayRoomCode').textContent = currentRoomCode;
                    document.getElementById('roomActions').classList.add('hidden');
                    document.getElementById('roomCreatedView').classList.remove('hidden');
                    showStatus('Room created successfully!', 'success');
                } else {
                    throw new Error('Failed to create room');
                }
            } catch (error) {
                console.error('Error creating room:', error);
                showStatus('Error creating room. Please check your API key and try again.', 'error');
            }
        }

        async function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showStatus('Please enter a valid 6-character room code', 'error');
                return;
            }

            showStatus('Joining room...', 'info');
            currentRoomCode = code;

            // Try to get bin ID from localStorage first
            let binId = localStorage.getItem('roomMapping_' + currentRoomCode);

            if (!binId) {
                showStatus('Room code not found. Make sure you entered the correct code.', 'error');
                return;
            }

            currentBinId = binId;
            
            // Try to load the room data
            const data = await loadRoomData();
            if (data) {
                startUsingRoom();
            } else {
                showStatus('Could not load room data. Please try again.', 'error');
            }
        }

        function startUsingRoom() {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = currentRoomCode;
            
            localStorage.setItem('currentRoomCode', currentRoomCode);
            localStorage.setItem('currentBinId', currentBinId);
            
            loadRoomData();
            startSync();
            renderCategories();
        }

        async function saveRoomData(data) {
            if (!currentBinId) return;

            const roomData = {
                roomCode: currentRoomCode,
                participants: data.participants || participants,
                matches: data.matches || matches,
                updated: new Date().toISOString()
            };

            try {
                // Use the API key if available, otherwise try without (read-only mode)
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (apiKey) {
                    headers['X-Master-Key'] = apiKey;
                }

                const response = await fetch(`https://api.jsonbin.io/v3/b/${currentBinId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(roomData)
                });

                if (!response.ok) {
                    throw new Error('Failed to save data');
                }
                
                return true;
            } catch (error) {
                console.error('Error saving room data:', error);
                alert('Error saving data. Please make sure you have an internet connection.');
                return false;
            }
        }

        async function loadRoomData() {
            if (!currentBinId) return null;

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${currentBinId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey || '$2a$10$dummyKeyForPublicAccess'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load data');
                }

                const result = await response.json();
                
                if (result.record) {
                    participants = result.record.participants || [];
                    matches = result.record.matches || [];
                    updateParticipantCount();
                    renderParticipants();
                    renderMatches();
                    return result.record;
                }
                
                return null;
            } catch (error) {
                console.error('Error loading room data:', error);
                return null;
            }
        }

        function startSync() {
            syncInterval = setInterval(() => {
                loadRoomData();
            }, 5000); // Sync every 5 seconds
        }

        function stopSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
        }

        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = participants.length;
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            Object.entries(GIFT_CATEGORIES).forEach(([categoryKey, category]) => {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = category.title;
                section.appendChild(title);

                const optionGroup = document.createElement('div');
                optionGroup.className = 'option-group';

                category.options.forEach(option => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'option-button';
                    button.textContent = option;
                    button.onclick = function() {
                        toggleOption(categoryKey, option, this);
                    };
                    optionGroup.appendChild(button);
                });

                section.appendChild(optionGroup);

                const customDiv = document.createElement('div');
                customDiv.className = 'custom-input';
                customDiv.innerHTML = `
                    <input type="text" id="custom-${categoryKey}" placeholder="Other (type your own)">
                    <button type="button" class="btn-add-custom" onclick="addCustomOption('${categoryKey}')">Add Custom Option</button>
                `;
                section.appendChild(customDiv);

                const customContainer = document.createElement('div');
                customContainer.id = `custom-container-${categoryKey}`;
                customContainer.style.marginTop = '10px';
                section.appendChild(customContainer);

                container.appendChild(section);
            });
        }

        function toggleOption(category, option, button) {
            if (!selectedPreferences[category]) {
                selectedPreferences[category] = [];
            }

            const index = selectedPreferences[category].indexOf(option);
            if (index > -1) {
                selectedPreferences[category].splice(index, 1);
                button.classList.remove('selected');
            } else {
                selectedPreferences[category].push(option);
                button.classList.add('selected');
            }
        }

        function addCustomOption(category) {
            const input = document.getElementById('custom-' + category);
            const value = input.value.trim();
            
            if (value) {
                if (!selectedPreferences[category]) {
                    selectedPreferences[category] = [];
                }
                
                selectedPreferences[category].push(value);
                
                const container = document.getElementById('custom-container-' + category);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'option-button selected';
                button.textContent = value + ' (custom)';
                button.onclick = function() {
                    const idx = selectedPreferences[category].indexOf(value);
                    if (idx > -1) {
                        selectedPreferences[category].splice(idx, 1);
                        this.remove();
                    }
                };
                container.appendChild(button);
                
                input.value = '';
            }
        }

        async function addParticipant() {
            const name = document.getElementById('nameInput').value.trim();
            const month = document.getElementById('monthInput').value;
            const day = document.getElementById('dayInput').value;

            if (!name || !month || !day) {
                alert('Please fill in name and birthday');
                return;
            }

            const participant = {
                id: Date.now().toString(),
                name: name,
                birthMonth: parseInt(month),
                birthDay: parseInt(day),
                preferences: JSON.parse(JSON.stringify(selectedPreferences))
            };

            participants.push(participant);
            await saveRoomData({ participants, matches });
            
            document.getElementById('nameInput').value = '';
            document.getElementById('monthInput').value = '';
            document.getElementById('dayInput').value = '';
            selectedPreferences = {};
            renderCategories();
            
            showViewTab();
        }

        function renderParticipants() {
            const list = document.getElementById('participantList');
            
            if (participants.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <p>No participants yet</p>
                        <p style="font-size: 14px; margin-top: 5px;">Add your first person to get started!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = '';
            
            participants.forEach(participant => {
                const card = document.createElement('div');
                card.className = 'participant-card';
                
                let preferencesHTML = '';
                if (participant.preferences && Object.keys(participant.preferences).length > 0) {
                    preferencesHTML = '<div class="participant-preferences">';
                    Object.entries(participant.preferences).forEach(([categoryKey, items]) => {
                        if (items && items.length > 0) {
                            const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                            preferencesHTML += `
                                <div class="preference-item">
                                    <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                                </div>
                            `;
                        }
                    });
                    preferencesHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="participant-header">
                        <div>
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-birthday">üéÇ ${MONTHS[participant.birthMonth - 1]} ${participant.birthDay}</div>
                        </div>
                        <button class="btn-delete" onclick="deleteParticipant('${participant.id}')">Delete</button>
                    </div>
                    ${preferencesHTML}
                `;
                
                list.appendChild(card);
            });
        }

        async function deleteParticipant(id) {
            if (confirm('Are you sure you want to delete this participant?')) {
                participants = participants.filter(p => p.id !== id);
                await saveRoomData({ participants, matches });
                renderParticipants();
            }
        }

        async function generateMatches() {
            if (participants.length < 2) {
                alert('You need at least 2 participants to generate matches!');
                return;
            }

            let receivers = [...participants];
            
            for (let i = receivers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
            }

            let isValid = false;
            let attempts = 0;
            const maxAttempts = 100;

            while (!isValid && attempts < maxAttempts) {
                isValid = true;
                for (let i = 0; i < participants.length; i++) {
                    if (participants[i].id === receivers[i].id) {
                        isValid = false;
                        const swapIndex = (i + 1) % receivers.length;
                        [receivers[i], receivers[swapIndex]] = [receivers[swapIndex], receivers[i]];
                    }
                }
                attempts++;
            }

            matches = participants.map((giver, index) => ({
                giver: giver,
                receiver: receivers[index]
            }));

            await saveRoomData({ participants, matches });
            
            document.getElementById('findMatchTab').style.display = 'block';
            
            alert('Matches generated! Everyone can now use the "Find My Match" tab to see who they\'re buying for.');
            renderMatches();
        }

        function renderMatches() {
            const list = document.getElementById('matchesList');
            
            if (matches.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <p>No matches generated yet</p>
                        <p style="font-size: 14px; margin-top: 5px;">Click "Generate Matches" to create Secret Santa pairs!</p>
                    </div>
                `;
                return;
            }

            document.getElementById('findMatchTab').style.display = 'block';

            list.innerHTML = '';
            
            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'match-card';
                
                let preferencesHTML = '';
                if (match.receiver.preferences && Object.keys(match.receiver.preferences).length > 0) {
                    preferencesHTML = '<div class="match-preferences"><div class="match-pref-title">üéØ Gift Ideas for ' + match.receiver.name + ':</div>';
                    Object.entries(match.receiver.preferences).forEach(([categoryKey, items]) => {
                        if (items && items.length > 0) {
                            const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                            preferencesHTML += `
                                <div class="preference-item">
                                    <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                                </div>
                            `;
                        }
                    });
                    preferencesHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="match-giver">${match.giver.name}</div>
                    <div class="match-arrow">‚¨áÔ∏è gives a gift to ‚¨áÔ∏è</div>
                    <div class="match-receiver">${match.receiver.name}</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">
                        üéÇ Birthday: ${MONTHS[match.receiver.birthMonth - 1]} ${match.receiver.birthDay}
                    </div>
                    ${preferencesHTML}
                `;
                
                list.appendChild(card);
            });
        }

        function findMyMatch() {
            const nameInput = document.getElementById('findNameInput').value.trim();
            const resultDiv = document.getElementById('myMatchResult');
            
            if (!nameInput) {
                alert('Please enter your name');
                return;
            }

            if (matches.length === 0) {
                resultDiv.innerHTML = `
                    <div class="no-match-found">
                        <h3>‚è≥ Matches Not Generated Yet</h3>
                        <p>The organizer hasn't generated the Secret Santa matches yet. Please check back later!</p>
                    </div>
                `;
                return;
            }

            const myMatch = matches.find(m => m.giver.name.toLowerCase() === nameInput.toLowerCase());

            if (!myMatch) {
                resultDiv.innerHTML = `
                    <div class="no-match-found">
                        <h3>‚ùå Name Not Found</h3>
                        <p>We couldn't find "${nameInput}" in the participant list.</p>
                        <p style="margin-top: 10px; font-size: 13px;">Make sure you entered your name exactly as it appears in the system.</p>
                    </div>
                `;
                return;
            }

            let preferencesHTML = '';
            if (myMatch.receiver.preferences && Object.keys(myMatch.receiver.preferences).length > 0) {
                preferencesHTML = '<div class="my-match-preferences"><h3>üéÅ Gift Ideas</h3>';
                Object.entries(myMatch.receiver.preferences).forEach(([categoryKey, items]) => {
                    if (items && items.length > 0) {
                        const categoryTitle = GIFT_CATEGORIES[categoryKey].title;
                        preferencesHTML += `
                            <div class="preference-item">
                                <span class="preference-label">${categoryTitle}:</span> ${items.join(', ')}
                            </div>
                        `;
                    }
                });
                preferencesHTML += '</div>';
            }

            resultDiv.innerHTML = `
                <div class="my-match-card">
                    <h2>üéÖ Your Secret Santa Match:</h2>
                    <div class="receiver-name">${myMatch.receiver.name}</div>
                    <div class="receiver-birthday">üéÇ Birthday: ${MONTHS[myMatch.receiver.birthMonth - 1]} ${myMatch.receiver.birthDay}</div>
                    ${preferencesHTML}
                </div>
            `;
        }

        function showAddTab() {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.getElementById('addSection').classList.remove('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
        }

        function showViewTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.remove('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
        }

        function showMatchTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.add('active');
            document.querySelectorAll('.tab')[3].classList.remove('active');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.remove('hidden');
            document.getElementById('findMatchSection').classList.add('hidden');
        }

        function showFindMatchTab() {
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
            document.querySelectorAll('.tab')[2].classList.remove('active');
            document.querySelectorAll('.tab')[3].classList.add('active');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('matchSection').classList.add('hidden');
            document.getElementById('findMatchSection').classList.remove('hidden');
        }

        window.onload = function() {
            // Check for saved API key
            const savedApiKey = localStorage.getItem('jsonbinApiKey');
            if (savedApiKey) {
                apiKey = savedApiKey;
                document.getElementById('apiKeyInput').value = savedApiKey;
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('roomActions').classList.remove('hidden');
            }

            // Check for saved room
            const savedRoomCode = localStorage.getItem('currentRoomCode');
            const savedBinId = localStorage.getItem('currentBinId');
            if (savedRoomCode && savedBinId) {
                currentRoomCode = savedRoomCode;
                currentBinId = savedBinId;
                loadRoomData().then(data => {
                    if (data) {
                        startUsingRoom();
                    }
                });
            }
        };

        window.onbeforeunload = function() {
            stopSync();
        };
    </script>
</body>
</html>
