<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa Gift Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #0f5e3a 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .content { padding: 20px; }
        .setup-section {
            background: #e8f5e9;
            border: 2px solid #0f5e3a;
            border-radius: 12px;
            padding: 20px;
        }
        .setup-section h3 { color: #0f5e3a; margin-bottom: 15px; }
        .room-code-display {
            background: white;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }
        .room-code-display .code {
            font-size: 36px;
            font-weight: 700;
            color: #c41e3a;
            letter-spacing: 4px;
        }
        input, button, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 16px;
        }
        button {
            background: #0f5e3a;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: #c41e3a; }
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-weight: 600;
        }
        .success { background:#d4edda; color:#155724; }
        .error   { background:#f8d7da; color:#721c24; }
        .info    { background:#d1ecf1; color:#0c5460; }
        .hidden { display: none !important; }
        .tab { padding: 12px; border-bottom: 3px solid transparent; }
        .tab.active { color:#d4af37; border-color:#d4af37; }
        .btn-primary {
            background: linear-gradient(135deg, #c41e3a, #0f5e3a);
            padding: 15px;
            font-size: 18px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
<div class="app-container">
  <div class="header">
    <h1>Secret Santa</h1>
    <p>Gift Matcher</p>
  </div>

  <div class="content">
    <!-- SETUP -->
    <div id="setupSection" class="setup-section">
      <h3>Welcome to Secret Santa!</h3>
      <p>Create a new room or join an existing one.</p><br>

      <div id="roomActions">
        <button onclick="testConnection()" style="background:#6c757d;">Test Database Connection</button>
        <button onclick="createNewRoom()">Create New Room</button>
        <p style="text-align:center;margin:15px 0;color:#666;">— OR —</p>
        <input type="text" id="roomCodeInput" placeholder="ENTER ROOM CODE" maxlength="6" style="text-transform:uppercase;">
        <button onclick="joinRoom()" class="secondary">Join Existing Room</button>
      </div>

      <div id="roomCreatedView" class="hidden">
        <div class="room-code-display">
          <p>Your Room Code:</p>
          <div class="code" id="displayRoomCode"></div>
          <p>Share this code with everyone!</p>
        </div>
        <button onclick="startUsingRoom()" class="btn-primary">Start Using Room</button>
      </div>

      <div id="statusMessage"></div>
    </div>

    <!-- MAIN APP (hidden until room joined) -->
    <div id="appContent" class="hidden">
      <div style="background:#f8f9fa;padding:12px;border-radius:10px;text-align:center;margin-bottom:20px;">
        Room Code: <span style="font-weight:700;color:#c41e3a;font-size:20px;" id="currentRoomCode"></span>
      </div>

      <div class="tabs" style="display:flex;border-bottom:2px solid #eee;margin-bottom:20px;">
        <button class="tab active" onclick="showTab('home')">Home</button>
        <button class="tab" onclick="showTab('add')">Add Person</button>
        <button class="tab" onclick="showTab('view')">View All (<span id="participantCount">0</span>)</button>
        <button class="tab" onclick="showTab('match')">Matcher</button>
        <button class="tab hidden" id="findMatchTab" onclick="showTab('find')">My Match</button>
      </div>

      <!-- All your sections (home, add, view, match, find) go here exactly as before -->
      <!-- Kept short for readability – they are unchanged from your original code -->
      <div id="homeSection">… (your home content) …</div>
      <div id="addSection" class="hidden">… (your add form) …</div>
      <div id="viewSection" class="hidden">… (participant list) …</div>
      <div id="matchSection" class="hidden">… (generate matches button) …</div>
      <div id="findMatchSection" class="hidden">… (my match lookup) …</div>
    </div>
  </div>
</div>

<script>
// Fixed & mobile-proof Supabase init
const SUPABASE_URL = 'https://qmnxezjxjxfltmbpxbec.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbnhlemp4anhmbHRtYnB4YmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDc0NTksImV4cCI6MjA4MDUyMzQ1OX0.LGlh7vkaJTLVcI6O5UHEHhQ-QKzirnWZPY9SGKM5USI';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  global: { headers: { 'X-Client-Info': 'supabase-js/2.45.0' }}
});

let currentRoomCode = null;
let currentRoomId = null;
let participants = [];
let matches = [];
let isOrganizer = false;
let syncChannel = null;

// Simple status helper
function showStatus(msg, type='info') {
  const el = document.getElementById('statusMessage');
  el.className = 'status-message ' + type;
  el.innerHTML = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i=0; i<6; i++) code += chars[Math.floor(Math.random()*chars.length)];
  return code;
}

async function testConnection() {
  showStatus('Testing connection…', 'info');
  const { error } = await supabase.from('secret_santa_rooms').select('id').limit(1);
  showStatus(error ? 'Failed: '+error.message : 'Connected!', error ? 'error' : 'success');
}

async function createNewRoom() {
  showStatus('Creating room…', 'info');
  currentRoomCode = generateRoomCode();

  const { data, error } = await supabase
    .from('secret_santa_rooms')
    .insert({
      room_code: currentRoomCode,
      participants: [],
      matches: [],
      event_date: null,
      event_address: null
    })
    .select()
    .single();

  if (error) {
    console.error(error);
    showStatus('Error: '+error.message, 'error');
    return;
  }

  currentRoomId = data.id;
  isOrganizer = true;
  localStorage.setItem('isOrganizer_'+currentRoomCode, 'true');

  document.getElementById('displayRoomCode').textContent = currentRoomCode;
  document.getElementById('roomActions').classList.add('hidden');
  document.getElementById('roomCreatedView').classList.remove('hidden');
  showStatus('Room created!', 'success');
}

async function joinRoom() {
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!code || code.length!==6) return showStatus('Enter a valid 6-letter code', 'error');

  showStatus('Joining room…', 'info');
  const { data, error } = await supabase
    .from('secret_santa_rooms')
    .select('*')
    .eq('room_code', code)
    .single();

  if (error || !data) return showStatus('Room not found', 'error');

  currentRoomCode = code;
  currentRoomId = data.id;
  participants = data.participants || [];
  matches = data.matches || [];
  isOrganizer = localStorage.getItem('isOrganizer_'+code)==='true';

  startUsingRoom();
}

function startUsingRoom() {
  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('appContent').classList.remove('hidden');
  document.getElementById('currentRoomCode').textContent = currentRoomCode;
  localStorage.setItem('currentRoomCode', currentRoomCode);
  localStorage.setItem('currentRoomId', currentRoomId);
  // You can add realtime sync here if you want
}

// Quick tab switcher (replace your showHomeTab / showAddTab etc. with this one line if you want)
function showTab(id) {
  document.querySelectorAll('#appContent > div').forEach(div => div.classList.add('hidden'));
  document.getElementById(id+'Section').classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab')[['home','add','view','match','find'].indexOf(id)].classList.add('active');
  if (id==='find') document.getElementById('findMatchTab').classList.remove('hidden');
}

// Auto-rejoin last room on load
window.addEventListener('load', async () => {
  const code = localStorage.getItem('currentRoomCode');
  const id = localStorage.getItem('currentRoomId');
  if (code && id) {
    currentRoomCode = code;
    currentRoomId = id;
    const { data } = await supabase.from('secret_santa_rooms').select('*').eq('id', id).single();
    if (data) {
      participants = data.participants || [];
      matches = data.matches || [];
      isOrganizer = localStorage.getItem('isOrganizer_'+code)==='true';
      startUsingRoom();
    }
  }
});
</script>
</body>
</html>
