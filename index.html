<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secret Santa Gift Matcher</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#c41e3a 0%,#0f5e3a 100%);min-height:100vh;padding:20px;color:#333}
.app{max-width:600px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.header{background:linear-gradient(135deg,#c41e3a,#0f5e3a);color:#fff;padding:35px 20px;text-align:center}
.header h1{font-size:28px;margin-bottom:5px}
.content{padding:20px}
.setup{background:#e8f5e9;border:2px solid #0f5e3a;border-radius:15px;padding:30px;text-align:center}
.setup h3{color:#0f5e3a;margin-bottom:15px;font-size:21px}
input[type=text],select{width:100%;padding:16px;border:2px solid #0f5e3a;border-radius:10px;margin:12px 0;font-size:18px;text-align:center}
button{width:100%;padding:16px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;color:#fff;margin:10px 0}
button:hover{opacity:.95}
.btn-create{background:#0f5e3a}
.btn-join{background:#c41e3a}
.btn-primary{background:linear-gradient(135deg,#c41e3a,#0f5e3a);padding:18px;font-size:19px;border-radius:12px}
.room-code{background:#fff;border:4px solid #d4af37;border-radius:15px;padding:25px;margin:25px 0;text-align:center}
.room-code .code{font-size:44px;font-weight:800;color:#c41e3a;letter-spacing:6px}
.tabs{display:flex;border-bottom:2px solid #eee;margin:20px 0}
.tab{flex:1;padding:15px;background:none;border:none;cursor:pointer;color:#666;font-weight:600}
.tab.active{color:#d4af37;border-bottom:4px solid #d4af37}
.hidden{display:none}
.category-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px}
.category-title{color:#c41e3a;font-size:19px;font-weight:700;margin-bottom:15px}
.option-group{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:15px}
.option-button{padding:12px 18px;background:#fff;border:2px solid #ddd;border-radius:30px;cursor:pointer;font-size:15px;transition:all .3s}
.option-button:hover{border-color:#0f5e3a;background:#e8f5e9}
.option-button.selected{background:#c41e3a;color:#fff;border-color:#c41e3a}
.birthday-inputs{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin:15px 0}
.participant-card{background:#f8f9fa;padding:18px;border-radius:12px;border-left:6px solid #d4af37;margin-bottom:15px}
.my-match-card{background:linear-gradient(135deg,#c41e3a,#0f5e3a);color:#fff;padding:35px;border-radius:18px;text-align:center;margin:20px 0;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.my-match-card .receiver-name{font-size:34px;font-weight:800;margin:25px 0}
.status{padding:15px;border-radius:10px;margin:15px 0;text-align:center;font-weight:600;display:none}
.success{background:#d4edda;color:#155724}
.error{background:#f8d7da;color:#721c24}
@media(max-width:600px){.birthday-inputs{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Secret Santa</h1>
    <p>Gift Matcher</p>
  </div>

  <div class="content">
    <div id="setupSection" class="setup">
      <h3>Welcome to Secret Santa!</h3>
      <p>Create a new room or join an existing one</p>

      <div id="roomActions">
        <button onclick="createNewRoom()" class="btn-create">Create New Room</button>
        <p style="margin:25px 0 10px;color:#666;font-size:18px">— or —</p>
        <input type="text" id="roomCodeInput" placeholder="ENTER ROOM CODE" maxlength="6" style="letter-spacing:5px;font-size:22px">
        <button onclick="joinRoom()" class="btn-join">Join Existing Room</button>
      </div>

      <div id="roomCreatedView" class="hidden">
        <div class="room-code">
          <p>Your Room Code</p>
          <div class="code" id="displayRoomCode"></div>
          <p style="margin-top:15px;color:#666;font-size:15px">Share this code with your friends!</p>
        </div>
        <button onclick="startUsingRoom()" class="btn-primary">Start Using Room</button>
      </div>

      <div id="statusMessage" class="status success"></div>
    </div>

    <div id="appContent" class="hidden">
      <div style="background:#f8f9fa;padding:15px;border-radius:12px;text-align:center;margin-bottom:25px">
        Room Code: <span id="currentRoomCode" style="font-weight:800;color:#c41e3a;font-size:24px"></span>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('home')">Home</button>
        <button class="tab" onclick="showTab('add')">Add Person</button>
        <button class="tab" onclick="showTab('view')">View All (<span id="participantCount">0</span>)</button>
        <button class="tab" onclick="showTab('match')">Matcher</button>
        <button class="tab hidden" id="findMatchTab" onclick="showTab('find')">My Match</button>
      </div>

      <div id="homeSection">
        <div style="text-align:center;padding:60px 20px">
          <h2 style="color:#c41e3a;margin-bottom:40px">Ready for Secret Santa!</h2>
          <button onclick="showTab('add')" class="btn-primary" style="width:auto;padding:16px 40px;margin:10px;font-size:18px">Add Your Info</button>
          <button onclick="showTab('view')" class="btn-primary" style="width:auto;padding:16px 40px;margin:10px;font-size:18px">View Participants</button>
        </div>
      </div>

      <div id="addSection" class="hidden">
        <input type="text" id="nameInput" placeholder="Your name *">
        <div class="birthday-inputs">
          <select id="monthInput">
            <option value="">Month</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
          <input type="number" id="dayInput" placeholder="Day" min="1" max="31">
        </div>
        <h3 style="margin:40px 0 20px">Gift Preferences (optional)</h3>
        <div id="categoriesContainer"></div>
        <button onclick="addParticipant()" class="btn-primary">Add Participant</button>
      </div>

      <div id="viewSection" class="hidden">
        <div id="organizerControls" class="hidden" style="text-align:center;margin-bottom:25px">
          <button onclick="deleteRoom()" style="background:#e74c3c;padding:12px 30px;border-radius:10px">Delete Room (Organizer Only)</button>
        </div>
        <div id="participantList"></div>
      </div>

      <div id="matchSection" class="hidden">
        <div style="text-align:center;padding:40px 20px">
          <button onclick="generateMatches()" class="btn-primary" style="padding:18px 50px;font-size:19px">Generate Secret Santa Matches</button>
        </div>
        <div id="matchesList"></div>
      </div>

      <div id="findMatchSection" class="hidden">
        <div style="max-width:400px;margin:40px auto;text-align:center">
          <h3>Find Your Match</h3>
          <p style="color:#666;margin:20px 0">Enter your name exactly as you typed it</p>
          <input type="text" id="findNameInput" placeholder="Your name" style="text-align:center;font-size:18px">
          <button onclick="findMyMatch()" class="btn-primary" style="margin-top:20px">Find My Match</button>
          <div id="myMatchResult" style="margin-top:40px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// This exact Supabase init works on iPhone Safari + Android Chrome
const { createClient } = window['@supabase/supabase-js'];
const supabase = createClient(
  'https://qmnxezjxjxfltmbpxbec.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbnhlemp4anhmbHRtYnB4YmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDc0NTksImV4cCI6MjA4MDUyMzQ1OX0.LGlh7vkaJTLVcI6O5UHEHhQ-QKzirnWZPY9SGKM5USI',
  { global: { headers: { 'X-Client-Info': 'supabase-js/2.45.0' } } }
);

const GIFT_CATEGORIES = {
  hobbies:{title:"Hobbies & Interests",options:["Reading","Gaming","Sports","Cooking","Gardening","Photography","Music","Crafts","Traveling","Fitness"]},
  foodDrink:{title:"Food & Drink",options:["Coffee","Tea","Wine","Chocolate","Snacks","Gourmet Foods","Baking","Cocktails","Beer","Candy"]},
  style:{title:"Style & Fashion",options:["Jewelry","Watches","Scarves","Bags","Sunglasses","Hats","Ties","Socks","Belts","Accessories"]},
  tech:{title:"Tech & Gadgets",options:["Phone Accessories","Smart Home","Headphones","Charging Cables","USB Drives","Bluetooth Speakers","Webcam","Mouse/Keyboard","Power Bank","Tech Organizer"]},
  wellness:{title:"Wellness & Self-Care",options:["Candles","Bath Products","Skincare","Aromatherapy","Massage Tools","Meditation Items","Essential Oils","Face Masks","Lip Balm","Hand Cream"]},
  home:{title:"Home & Office",options:["Desk Organizer","Plants","Picture Frames","Mugs","Coasters","Blankets","Pillows","Wall Art","Notebooks","Pens"]}
};

const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

let currentRoomCode = null;
let currentRoomId = null;
let participants = [];
let selectedPreferences = {};
let matches = [];
let isOrganizer = false;

function showStatus(msg, type='success') {
  const el = document.getElementById('statusMessage');
  el.textContent = msg;
  el.className = 'status ' + type;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

async function createNewRoom() {
  showStatus('Creating room...');
  currentRoomCode = generateRoomCode();

  const { data, error } = await supabase
    .from('secret_santa_rooms')
    .insert({
      room_code: currentRoomCode,
      participants: [],
      matches: [],
      event_date: null,
      event_address: null
    })
    .select()
    .single();

  if (error) {
    showStatus('Error: ' + error.message, 'error');
    console.error(error);
    return;
  }

  currentRoomId = data.id;
  isOrganizer = true;
  localStorage.setItem('isOrganizer_' + currentRoomCode, 'true');

  document.getElementById('displayRoomCode').textContent = currentRoomCode;
  document.getElementById('roomActions').classList.add('hidden');
  document.getElementById('roomCreatedView').classList.remove('hidden');
  showStatus('Room created successfully!');
}

async function joinRoom() {
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!code || code.length !== 6) {
    showStatus('Please enter a valid 6-letter code', 'error');
    return;
  }

  const { data, error } = await supabase
    .from('secret_santa_rooms')
    .select('*')
    .eq('room_code', code)
    .single();

  if (error || !data) {
    showStatus('Room not found', 'error');
    return;
  }

  currentRoomCode = code;
  currentRoomId = data.id;
  participants = data.participants || [];
  matches = data.matches || [];
  isOrganizer = localStorage.getItem('isOrganizer_' + code) === 'true';

  startUsingRoom();
}

function startUsingRoom() {
  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('appContent').classList.remove('hidden');
  document.getElementById('currentRoomCode').textContent = currentRoomCode;
  localStorage.setItem('currentRoomCode', currentRoomCode);
  localStorage.setItem('currentRoomId', currentRoomId);

  renderCategories();
  document.getElementById('participantCount').textContent = participants.length;
  renderParticipants();

  if (isOrganizer) {
    document.getElementById('organizerControls').classList.remove('hidden');
  }
}

function renderCategories() {
  const container = document.getElementById('categoriesContainer');
  container.innerHTML = '';

  Object.entries(GIFT_CATEGORIES).forEach(([key, cat]) => {
    const section = document.createElement('div');
    section.className = 'category-section';
    section.innerHTML = `<div class="category-title">${cat.title}</div><div class="option-group"></div>
      <div style="margin-top:12px"><input type="text" placeholder="Add your own idea..." style="width:70%;padding:12px">
      <button onclick="addCustomOption('${key}', this.previousElementSibling)" style="width:28%;background:#0f5e3a">Add</button></div>
      <div id="custom-${key}" style="margin-top:10px"></div>`;

    const group = section.querySelector('.option-group');
    cat.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'option-button';
      btn.textContent = opt;
      btn.onclick = () => {
        if (!selectedPreferences[key]) selectedPreferences[key] = [];
        const idx = selectedPreferences[key].indexOf(opt);
        if (idx > -1) {
          selectedPreferences[key].splice(idx, 1);
          btn.classList.remove('selected');
        } else {
          selectedPreferences[key].push(opt);
          btn.classList.add('selected');
        }
      };
      group.appendChild(btn);
    });

    container.appendChild(section);
  });
}

function addCustomOption(key, input) {
  const value = input.value.trim();
  if (!value) return;
  if (!selectedPreferences[key]) selectedPreferences[key] = [];
  selectedPreferences[key].push(value);

  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'option-button selected';
  btn.textContent = value + ' (custom)';
  btn.onclick = () => {
    selectedPreferences[key] = selectedPreferences[key].filter(x => x !== value);
    btn.remove();
  };
  document.getElementById('custom-' + key).appendChild(btn);
  input.value = '';
}

async function addParticipant() {
  const name = document.getElementById('nameInput').value.trim();
  const month = document.getElementById('monthInput').value;
  const day = document.getElementById('dayInput').value;

  if (!name || !month || !day) {
    alert('Please enter your name and birthday');
    return;
  }

  const newParticipant = {
    id: Date.now().toString(),
    name: name,
    birthMonth: parseInt(month),
    birthDay: parseInt(day),
    preferences: structuredClone(selectedPreferences)
  };

  participants.push(newParticipant);
  await supabase
    .from('secret_santa_rooms')
    .update({ participants: participants })
    .eq('id', currentRoomId);

  // Reset form
  document.getElementById('nameInput').value = '';
  document.getElementById('monthInput').value = '';
  document.getElementById('dayInput').value = '';
  selectedPreferences = {};
  renderCategories();

  document.getElementById('participantCount').textContent = participants.length;
  renderParticipants();
  alert('Successfully added!');
  showTab('view');
}

function renderParticipants() {
  const list = document.getElementById('participantList');
  list.innerHTML = participants.length === 0 
    ? '<div style="text-align:center;padding:60px;color:#999;font-size:18px">No participants yet<br>Be the first!</div>'
    : '';

  participants.forEach(p => {
    let prefs = '';
    if (p.preferences && Object.keys(p.preferences).length) {
      prefs = '<div style="margin-top:12px;font-size:14px">';
      Object.entries(p.preferences).forEach(([k, items]) => {
        if (items.length) prefs += `<div><b>${GIFT_CATEGORIES[k].title}:</b> ${items.join(', ')}</div>`;
      });
      prefs += '</div>';
    }

    list.innerHTML += `
      <div class="participant-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700;font-size:19px">${p.name}</div>
            <div style="color:#666">Birthday: ${MONTHS[p.birthMonth-1]} ${p.birthDay}</div>
          </div>
          ${isOrganizer ? `<button style="background:#e74c3c;color:#fff;padding:8px 15px;border-radius:8px" onclick="if(confirm('Delete ${p.name}?')){participants=participants.filter(x=>x.id!=='${p.id}');supabase.from('secret_santa_rooms').update({participants}).eq('id',currentRoomId);renderParticipants();document.getElementById('participantCount').textContent=participants.length}">Delete</button>` : ''}
        </div>
        ${prefs}
      </div>`;
  });
}

async function generateMatches() {
  if (participants.length < 2) return alert('Need at least 2 participants');
  
  let receivers = [...participants];
  for (let i = receivers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
  }

  let valid = false, attempts = 0;
  while (!valid && attempts < 100) {
    valid = true;
    for (let i = 0; i < participants.length; i++) {
      if (participants[i].id === receivers[i].id) {
        valid = false;
        const swap = (i + 1) % receivers.length;
        [receivers[i], receivers[swap]] = [receivers[swap], receivers[i]];
      }
    }
    attempts++;
  }

  matches = participants.map((giver, i) => ({ giver, receiver: receivers[i] }));
  await supabase.from('secret_santa_rooms').update({ matches }).eq('id', currentRoomId);
  document.getElementById('findMatchTab').style.display = 'block';
  alert('Matches generated! Everyone can now check "My Match"');
  renderMatches();
}

function renderMatches() {
  const list = document.getElementById('matchesList');
  list.innerHTML = '';
  matches.forEach(m => {
    let prefs = '';
    if (m.receiver.preferences && Object.keys(m.receiver.preferences).length) {
      prefs = '<div style="background:#fff;padding:20px;border-radius:12px;margin-top:20px">';
      Object.entries(m.receiver.preferences).forEach(([k, v]) => {
        if (v.length) prefs += `<div><b>${GIFT_CATEGORIES[k].title}:</b> ${v.join(', ')}</div>`;
      });
      prefs += '</div>';
    }
    list.innerHTML += `
      <div style="background:#f8f9fa;padding:25px;border-radius:15px;margin:15px 0;border-left:6px solid #d4af37;text-align:center">
        <div style="font-size:21px;font-weight:700;color:#c41e3a">${m.giver.name}</div>
        <div style="font-size:32px;margin:20px 0">gives to</div>
        <div style="font-size:24px;color:#0f5e3a;font-weight:700">${m.receiver.name}</div>
        <div style="color:#666;margin-top:10px">Birthday: ${MONTHS[m.receiver.birthMonth-1]} ${m.receiver.birthDay}</div>
        ${prefs}
      </div>`;
  });
}

function findMyMatch() {
  const name = document.getElementById('findNameInput').value.trim();
  const result = document.getElementById('myMatchResult');
  if (!name) return result.innerHTML = '<div style="color:#721c24">Please enter your name</div>';
  if (!matches.length) return result.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:12px">Matches not generated yet</div>';

  const match = matches.find(m => m.giver.name.toLowerCase() === name.toLowerCase());
  if (!match) return result.innerHTML = '<div style="background:#fff3cd;padding:20px;border-radius:12px">Name not found — check spelling</div>';

  let prefs = '';
  if (match.receiver.preferences && Object.keys(match.receiver.preferences).length) {
    prefs = '<div style="background:#fff;padding:25px;border-radius:12px;margin-top:25px">';
    Object.entries(match.receiver.preferences).forEach(([k, v]) => {
      if (v.length) prefs += `<div style="margin:8px 0"><b>${GIFT_CATEGORIES[k].title}:</b> ${v.join(', ')}</div>`;
    });
    prefs += '</div>';
  }

  result.innerHTML = `
    <div class="my-match-card">
      <h2>Your Secret Santa Match</h2>
      <div class="receiver-name">${match.receiver.name}</div>
      <div style="font-size:19px;margin:15px 0">Birthday: ${MONTHS[match.receiver.birthMonth-1]} ${match.receiver.birthDay}</div>
      ${prefs}
    </div>`;
}

async function deleteRoom() {
  if (!isOrganizer) return alert('Only the room creator can delete it');
  if (!confirm('Delete this entire room? This cannot be undone!')) return;
  await supabase.from('secret_santa_rooms').delete().eq('id', currentRoomId);
  localStorage.clear();
  location.reload();
}

function showTab(tab) {
  document.querySelectorAll('#appContent > div[id$="Section"]').forEach(d => d.classList.add('hidden'));
  document.getElementById(tab + 'Section').classList.remove('hidden');
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === ['home','add','view','match','find'].indexOf(tab)));
  if (tab === 'find') document.getElementById('findMatchTab').style.display = 'block';
  if (tab === 'add') renderCategories();
}

// Auto-rejoin last room
window.addEventListener('load', async () => {
  const code = localStorage.getItem('currentRoomCode');
  if (code) {
    const { data } = await supabase.from('secret_santa_rooms').select('id,participants,matches').eq('room_code', code).single();
    if (data) {
      currentRoomCode = code;
      currentRoomId = data.id;
      participants = data.participants || [];
      matches = data.matches || [];
      isOrganizer = localStorage.getItem('isOrganizer_' + code) === 'true';
      startUsingRoom();
    }
  }
});
</script>
</body>
</html>
